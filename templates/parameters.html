{% extends 'base.html' %}

{% block title %}
Parameters
{% endblock title %}

{% block sidebar %}
<div class="sidebar white" id="sidebar">
    <h4 class="center black-text" style="margin-top: 20px; font-weight: bold; font-size: 24px;">Portfolio Config</h4>
    <form method="post">
        {% csrf_token %}
        <div class="row">
            <div class="input-field col s12">
                <input placeholder="Investment Amount" id="amount" type="text" class="validate black-text" name="amount" value="{{ form.amount.value|default_if_none:'' }}">
                <label for="amount" class="black-text">{{ form.amount.label }}</label>
                {% if form.amount.errors %}
                <div class="black-text">{{ form.amount.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Amount of Stocks" id="amount_stocks" type="text" class="validate black-text" name="amount_stocks" value="{{ form.amount_stocks.value|default_if_none:'' }}">
                <label for="amount_stocks" class="black-text">{{ form.amount_stocks.label }}</label>
                {% if form.amount_stocks.errors %}
                <div class="black-text">{{ form.amount_stocks.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Time Frame (DD/MM/YYYY)" id="time_frame" type="date" class="validate black-text" name="time_frame" value="{{ form.time_frame.value|default_if_none:'' }}">
                <label for="time_frame" class="black-text">{{ form.time_frame.label }}</label>
                {% if form.time_frame.errors %}
                <div class="black-text">{{ form.time_frame.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Investment Horizon (months)" id="horizon" type="text" class="validate black-text" name="horizon" value="{{ form.horizon.value|default_if_none:'' }}">
                <label for="horizon" class="black-text">{{ form.horizon.label }}</label>
                {% if form.horizon.errors %}
                <div class="black-text">{{ form.horizon.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Confidence Level" id="confidence" type="text" class="validate black-text" name="confidence" value="{{ form.confidence.value|default_if_none:'' }}">
                <label for="confidence" class="black-text">{{ form.confidence.label }}</label>
                {% if form.confidence.errors %}
                <div class="black-text">{{ form.confidence.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Minimum Volatility" id="min_var" type="text" class="validate black-text" name="min_var" value="{{ form.min_var.value|default_if_none:'' }}">
                <label for="min_var" class="black-text">{{ form.min_var.label }}</label>
                {% if form.min_var.errors %}
                <div class="black-text">{{ form.min_var.errors }}</div>
                {% endif %}
            </div>
            <button class="btn waves-effect waves-light" type="submit" name="action">Submit</button>
        </div>
    </form>
</div>
{% endblock sidebar %}

{% block content %}

<div class="col s12">
    <h4 class="center white-text">{{ title }}</h4>
    <div class="row">
        <canvas id="myChart"></canvas>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Percentage</th>
            <th>Investment Amount</th>
            <th>Market Cap</th>
            <th>Enterprise Value</th>
            <th>Trailing P/E</th>
        </tr>
    </thead>
    <tbody>
        {% for key, item in financial_data.items %}
        <tr>
            <td>{{ item.Ticker }}</td>
            <td>{{ item.Percentage }}</td>
            <td>{{ item.InvestmentAmount }}</td>
            <td>{{ item.valuation.MarketCap }}</td>
            <td>{{ item.valuation.EnterpriseValue }}</td>
            <td>{{ item.valuation.TrailingPE }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="fixed-action-btn">
    <a id="toggle-button" class="btn-floating  btn-large waves-effect waves-light red bottom right "><i class="material-icons">add</i></a>
</div>

<script>
    var chartData = JSON.parse('{{ chart_data|escapejs }}');
    var chartType = '{{ chart_type|escapejs }}';

    function interpolateColor(value, min, max) {
        scale = d3.scaleSequential(d3.interpolateViridis).domain([min, max]);
        return scale(value);
    }

    if (chartType == 'scatter'){
        // Calculate min and max Sharpe ratios
        minSharpe = Math.min(...chartData.sharpe);
        maxSharpe = Math.max(...chartData.sharpe);

        // Create the dataset with dynamic colors
        data = chartData.x.map((x, i) => {
            color = interpolateColor(chartData.sharpe[i], minSharpe, maxSharpe);
            return {
                x: x,
                y: chartData.y[i],
                backgroundColor: "#000000",
                borderColor: "#000000",
                pointRadius: 3,
            };
        });
    }
    var pointBackgroundColors = [];
    let ctx = document.getElementById('myChart').getContext('2d');
    if (chartType == 'line') {
        config = {
            type: 'line',
            data: {
                labels: chartData.x,
                datasets: [{
                    label: 'S&P 500',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    data: chartData.y,
                    borderWidth: 1,
                    fill: true,
                    pointStyle: false,
                    pointRadius: 0,
                },
                {
                    label: '50-Day Moving Average',
                    data: chartData.avg,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    borderDash: [5, 5],
                }]
            },
        }
        var myChart = new Chart(ctx, config);
    } else if (chartType == 'scatter') {
        config = {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Efficient Frontier',
                    data: data,
                    pointBackgroundColor: pointBackgroundColors,
                    pointStyle: 'circle',
                    pointRadius: 2.5,
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Risk'
                        }
                    },
                    y: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Return'
                        }
                    }
                }, plugins: {
                    legend: {
                        display: false,
                    }
                }
            }
        };
        var myChart = new Chart(ctx, config);
        minSharpe = Math.min(...chartData.sharpe);
        maxSharpe = Math.max(...chartData.sharpe);

        for (i = 0; i < myChart.data.datasets[0].data.length; i++) {
            //color = interpolateColor(myChart.data.datasets[0].sharpe[i], minSharpe, maxSharpe);
            color = interpolateColor(chartData.sharpe[i], minSharpe, maxSharpe);
            pointBackgroundColors.push(color);
        }
        myChart.update();
    }

    
    
    

    
</script>
{% endblock content %}
