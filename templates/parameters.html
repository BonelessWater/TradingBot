{% extends 'base.html' %}

{% block title %}
Parameters | Portfolio Builder
{% endblock title %}

{% block sidebar %}
<div class="sidebar white" id="sidebar">
    <h4 class="center black-text" style="margin-top: 20px; font-weight: bold; font-size: 24px;">Portfolio Config</h4>
    <form method="post">
        {% csrf_token %}
        <div class="row">
            <div class="input-field col s12">
                <input placeholder="Investment Amount" id="amount" type="text" class="validate black-text" name="amount" value="{{ form.amount.value|default_if_none:'' }}">
                <label for="amount" class="black-text">{{ form.amount.label }}</label>
                {% if form.amount.errors %}
                <div class="black-text">{{ form.amount.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Amount of Stocks" id="amount_stocks" type="text" class="validate black-text" name="amount_stocks" value="{{ form.amount_stocks.value|default_if_none:'' }}">
                <label for="amount_stocks" class="black-text">{{ form.amount_stocks.label }}</label>
                {% if form.amount_stocks.errors %}
                <div class="black-text">{{ form.amount_stocks.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Investment Horizon (months)" id="horizon" type="text" class="validate black-text" name="horizon" value="{{ form.horizon.value|default_if_none:'' }}">
                <label for="horizon" class="black-text">{{ form.horizon.label }}</label>
                {% if form.horizon.errors %}
                <div class="black-text">{{ form.horizon.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Confidence Level" id="confidence" type="text" class="validate black-text" name="confidence" value="{{ form.confidence.value|default_if_none:'' }}">
                <label for="confidence" class="black-text">{{ form.confidence.label }}</label>
                {% if form.confidence.errors %}
                <div class="black-text">{{ form.confidence.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Target Volatility" id="min_var" type="text" class="validate black-text" name="min_var" value="{{ form.min_var.value|default_if_none:'' }}">
                <label for="min_var" class="black-text">{{ form.min_var.label }}</label>
                {% if form.min_var.errors %}
                <div class="black-text">{{ form.min_var.errors }}</div>
                {% endif %}
            </div>
            <div class="input-field col s12">
                <input placeholder="Target Return" id="min_return" type="text" class="validate black-text" name="min_return" value="{{ form.min_return.value|default_if_none:'' }}">
                <label for="min_return" class="black-text">{{ form.min_return.label }}</label>
                {% if form.min_return.errors %}
                <div class="black-text">{{ form.min_return.errors }}</div>
                {% endif %}
            </div>
            <button class="btn waves-effect waves-light" type="submit" name="action">Submit</button>
        </div>
    </form>
</div>
{% endblock sidebar %}

{% block content %}
    {% if is_post %}
    <div class="container">
        <!--Sharpe-->
        <div class="col s12">
            <div class="row">
                <canvas id="myChartSharpe"></canvas>
                <h6>Sharpe Ratio:</h6>
                <div id="colorScaleBarSharpe" class="color-scale-bar"></div>
            </div>
        </div>
        <div>
            <div class="card">
                <div class="card-content">
                    <div>
                        <h5 class="center card-title">Best Portfolio by Sharpe Ratio</h5>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Percentage</th>
                                <th>Investment Amount</th>
                                <th>Market Cap</th>
                                <th>Enterprise Value</th>
                                <th>Trailing P/E</th>
                                <th>Forward P/E</th>
                                <th>PEG Ratio</th>
                                <th>Price Sales</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, item in sharpe_dict.financial_data_sharpe.items %}
                            <tr>
                                <td>{{ item.ticker }}</td>
                                <td>{{ item.percentage }}</td>
                                <td>{{ item.investmentamount }}</td>
                                <td>{{ item.marketcap }}</td>
                                <td>{{ item.enterprisevalue }}</td>
                                <td>{{ item.trailingpe }}</td>
                                <td>{{ item.forwardpe }}</td>
                                <td>{{ item.pegratio }}</td>
                                <td>{{ item.pricesales }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!--Risk-->
        <div class="col s12">
            <div class="row">
                <canvas id="myChartRisk"></canvas>
                <h6>Sharpe Ratio:</h6>
                <div id="colorScaleBarRisk" class="color-scale-bar"></div>
            </div>
        </div>
        <div>
            <div class="card">
                <div class="card-content">
                    <div>
                        <h5 class="center card-title">Best Portfolio by Risk</h5>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Percentage</th>
                                <th>Investment Amount</th>
                                <th>Market Cap</th>
                                <th>Enterprise Value</th>
                                <th>Trailing P/E</th>
                                <th>Forward P/E</th>
                                <th>PEG Ratio</th>
                                <th>Price Sales</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, item in risk_dict.financial_data_risk.items %}
                            <tr>
                                <td>{{ item.ticker }}</td>
                                <td>{{ item.percentage }}</td>
                                <td>{{ item.investmentamount }}</td>
                                <td>{{ item.marketcap }}</td>
                                <td>{{ item.enterprisevalue }}</td>
                                <td>{{ item.trailingpe }}</td>
                                <td>{{ item.forwardpe }}</td>
                                <td>{{ item.pegratio }}</td>
                                <td>{{ item.pricesales }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!--Returns-->

        <div class="col s12">
            <div class="row">
                <canvas id="myChartReturn"></canvas>
                <h6>Sharpe Ratio:</h6>
                <div id="colorScaleBarReturn" class="color-scale-bar"></div>
            </div>
        </div>
        <div>
            <div class="card">
                <div class="card-content">
                    <div>
                        <h5 class="center card-title">Best Portfolio by Returns</h5>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Percentage</th>
                                <th>Investment Amount</th>
                                <th>Market Cap</th>
                                <th>Enterprise Value</th>
                                <th>Trailing P/E</th>
                                <th>Forward P/E</th>
                                <th>PEG Ratio</th>
                                <th>Price/Sales</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, item in return_dict.financial_data_return.items %}
                            <tr>
                                <td>{{ item.ticker }}</td>
                                <td>{{ item.percentage }}</td>
                                <td>{{ item.investmentamount }}</td>
                                <td>{{ item.marketcap }}</td>
                                <td>{{ item.enterprisevalue }}</td>
                                <td>{{ item.trailingpe }}</td>
                                <td>{{ item.forwardpe }}</td>
                                <td>{{ item.pegratio }}</td>
                                <td>{{ item.pricesales }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>

        var chartType = '{{ chart_type|escapejs }}';

        document.addEventListener('DOMContentLoaded', function () {

            function interpolateColor(value, min, max) {
                scale = d3.scaleSequential(d3.interpolateViridis).domain([min, max]);
                return scale(value);
            }

            function createChart(chartData, id, colorbar){
                var pointBackgroundColors = [];
                let ctx = document.getElementById(id).getContext('2d');   

                // Calculate min and max Sharpe ratios
                minSharpe = Math.min(...chartData.sharpe);
                maxSharpe = Math.max(...chartData.sharpe);

                // Create the dataset with dynamic colors
                data = chartData.x.map((x, i) => {
                    color = interpolateColor(chartData.sharpe[i], minSharpe, maxSharpe);
                    return {
                        x: x,
                        y: chartData.y[i],
                        backgroundColor: "#000000",
                        borderColor: "#000000",
                        pointRadius: 3,
                    };
                });

                config = {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Efficient Frontier',
                            data: data,
                            pointBackgroundColor: pointBackgroundColors,
                            pointStyle: 'circle',
                            pointRadius: 2.5,
                        }]
                    }, 
                    options: {
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Risk'
                                }
                            },
                            y: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Return'
                                }
                            }
                        }, plugins: {
                            title: {
                                display: true,
                                text: 'Efficient Frontier',
                                font: {
                                    size: 20
                                }
                            },
                            legend: {
                                display: false,
                            }
                        }
                    }
                };
                var myChart = new Chart(ctx, config);
                minSharpe = Math.min(...chartData.sharpe);
                maxSharpe = Math.max(...chartData.sharpe);

                for (i = 0; i < myChart.data.datasets[0].data.length; i++) {
                    //color = interpolateColor(myChart.data.datasets[0].sharpe[i], minSharpe, maxSharpe);
                    color = interpolateColor(chartData.sharpe[i], minSharpe, maxSharpe);
                    pointBackgroundColors.push(color);
                }
                myChart.update();

                // Create the color scale bar
                const colorScaleBar = document.getElementById(colorbar);
                const numColors = 50; // Number of steps in the color scale
                for (let i = 0; i <= numColors; i++) {
                    const value = minSharpe + (i / numColors) * (maxSharpe - minSharpe);
                    const color = interpolateColor(value, minSharpe, maxSharpe);
                    const div = document.createElement('div');
                    div.style.backgroundColor = color;
                    colorScaleBar.appendChild(div);
                }

                // Add min and max Sharpe values
                const minLabel = document.createElement('span');
                minLabel.textContent = `Min: ${minSharpe.toFixed(2)}`;
                colorScaleBar.appendChild(minLabel);

                const maxLabel = document.createElement('span');
                maxLabel.textContent = `Max: ${maxSharpe.toFixed(2)}`;
                colorScaleBar.appendChild(maxLabel);
            }
        

        var id_sharpe = 'myChartSharpe';
        var color_bar_sharpe = 'colorScaleBarSharpe';
        var id_risk = 'myChartRisk';
        var color_bar_risk = 'colorScaleBarRisk';
        var id_return = 'myChartReturn';
        var color_bar_return = 'colorScaleBarReturn';

        let total_data = [JSON.parse('{{ sharpe_data|escapejs }}'), JSON.parse('{{ risk_data|escapejs }}'), JSON.parse('{{ return_data|escapejs }}')]

        createChart(total_data[0], id_sharpe, color_bar_sharpe);
        createChart(total_data[1], id_risk, color_bar_risk);
        createChart(total_data[2], id_return, color_bar_return);

        });
    </script>
    {% else %}
    <div class="container">
        <div class="row">
            <div class="col s12 m8 offset-m2">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">Portfolio Optimizer</span>
                        <p>Use the button on the bottom right to construct your portfolio according to your needs.</p>
                        {% if error %}
                            <div class="card-panel red lighten-4">
                                <span class="red-text text-darken-4">{{ message }}</span>
                            </div>
                        {% endif %}
                        <div class="advice-section">
                            <h6>Helpful Tips:</h6>
                            <ul>
                                <li>Pick a confidence level between 0 and 1.</li>
                                <li>Try values of target volatility of 0.6 or greater.</li>
                                <li>Try values of target returns of 0.3 or less.</li>
                            </ul>
                        </div>                        
                    </div>
                    <div class="card-action center">
                        <button id="toggle-button" class="btn waves-effect waves-light red" type="submit" name="action">Construct Portfolio
                            <i class="material-icons right">build</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% endif %}
    <div class="fixed-action-btn">
        <a id="toggle-button" class="btn-floating btn-large waves-effect waves-light red bottom right "><i class="material-icons">add</i></a>
    </div>
{% endblock content %}